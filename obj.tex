% -*- expl3 -*-

\file_input:n { parsing }

\clist_new:N \g__obj_obj__types_clist
\clist_set:Nn \g__obj_obj__types_clist
  { obj, tl, seq, int, color }

\msg_new:nnn { obj } { unknown-type }
  { The~type~you~have~provided~is~not~known~to~exist:~`#1' }

\msg_new:nnn { obj } { unknown-field }
  { The~field~you~have~provided~is~not~known~to~exist~for~this~object:~`#1'.`#2' }

\cs_new:Nn \__obj_new:nn     { \prop_new:c         { g__obj_#1_#2_prop } }
\cs_new:Nn \__obj_set_eq:nnn { \prop_set_eq:cc     { g__obj_#1_#3_prop } { g__obj_#2_#3_prop } }
\cs_new:Nn \__obj_add:nnnn   { \prop_put:cnn       { g__obj_#1_#2_prop } {#3} {#4} }
\cs_new:Nn \__obj_map:nnn    { \prop_map_inline:cn { g__obj_#1_#2_prop } {#3} }
\cs_generate_variant:Nn \__obj_new:nn { Vn }
\cs_generate_variant:Nn \__obj_set_eq:nnn { VVn }
\cs_generate_variant:Nn \__obj_add:nnnn { VnVV }
\cs_generate_variant:Nn \__obj_map:nnn { Vnn }

\tl_new:N \l__obj_class_name_tl
\tl_new:N \l__obj_superclass_name_tl
\seq_new:N \l__obj_heirarchy_seq
\cs_new:Nn \obj_new:nn
  {
    \seq_set_split:Nnn \l__obj_heirarchy_seq { / } {#1}
    \seq_pop_right:NN \l__obj_heirarchy_seq \l__obj_class_name_tl
    \seq_pop_right:NN \l__obj_heirarchy_seq \l__obj_superclass_name_tl
    \__obj_new:Vn \l__obj_class_name_tl { spec }
    \__obj_new:Vn \l__obj_class_name_tl { proto }

    \quark_if_no_value:NF \l__obj_superclass_name_tl
      {
        \__obj_set_eq:VVn \l__obj_class_name_tl \l__obj_superclass_name_tl { spec }
        \__obj_set_eq:VVn \l__obj_class_name_tl \l__obj_superclass_name_tl { proto }
      }

    \parse_dictionary:nn {#2}
      {
        \clist_if_in:NVF
          \g__obj_obj__types_clist
          \l_parse_dictionary_type_tl
          {
            \msg_warning:nnx { obj } { unknown-type }
              { \tl_use:N \l_parse_dictionary_type_tl }
          }
        \__obj_add:VnVV \l__obj_class_name_tl { spec }
          \l_parse_dictionary_key_tl
          \l_parse_dictionary_type_tl
        \__obj_add:VnVV \l__obj_class_name_tl { proto }
          \l_parse_dictionary_key_tl
          \l_parse_dictionary_value_tl
        \__obj_new_getter:VV \l__obj_class_name_tl \l_parse_dictionary_key_tl
        \__obj_new_setter:VV \l__obj_class_name_tl \l_parse_dictionary_key_tl
      }
    \cs_set_eq:cN { \tl_use:N \l__obj_class_name_tl _new:N } \prop_new:N
    \cs_set_eq:cN { \tl_use:N \l__obj_class_name_tl _show:N } \prop_show:N
    \cs_set_eq:cN { \tl_use:N \l__obj_class_name_tl _get:Nn } \prop_item:Nn
    \cs_new:cpn { \tl_use:N \l__obj_class_name_tl _set:Nn } { \__obj_set:nNn { \tl_use:N \l__obj_class_name_tl } }
    \cs_new:cn { \tl_use:N \l__obj_class_name_tl _new:Nn }
      {
        \use:c { \tl_use:N \l__obj_class_name_tl _new:N  } ##1
        \use:c { \tl_use:N \l__obj_class_name_tl _set:Nn } ##1 {##2}
        \__obj_map:Vnn \l__obj_class_name_tl { proto }
          { \prop_put_if_new:Nnn ##1 {####1} {####2} }
      }
  }

\cs_new:Nn \__obj_new_getter:nn
  { \cs_new:cn { #1_#2:N } { \prop_item:Nn ##1 {#2} } }
\cs_new:Nn \__obj_new_setter:nn
  { \cs_new:cn { #1_#2:Nn } { \prop_put:Nnn ##1 {#2} {##2} } }
\cs_generate_variant:Nn \__obj_new_getter:nn { VV }
\cs_generate_variant:Nn \__obj_new_setter:nn { VV }

\cs_new:Nn \__obj_set:nNn
  {
    \parse_prop:nn {#3}
      {
        \prop_if_in:cVF { g__obj_#1_spec_prop } \l_parse_prop_key_tl
          {
            \msg_error:nnnx { obj } { unknown-field } {#1}
              { \tl_use:N \l_parse_prop_key_tl }
          }
        \prop_put:NVV #2 \l_parse_prop_key_tl \l_parse_prop_value_tl
      }
  }

\cs_new:Nn \obj_show:n
  {
    \prop_show:c { g__obj_#1_spec_prop }
    \prop_show:c { g__obj_#1_proto_prop }
  }
