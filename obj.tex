% -*- expl3 -*-

\file_input:n { parsing }

\clist_new:N \g__obj_obj__types_clist
\clist_set:Nn \g__obj_obj__types_clist
  { obj, tl, seq, int, color }

\msg_new:nnn { obj } { unknown-type }
  { The~type~you~have~provided~is~not~known~to~exist:~`#1' }

\msg_new:nnn { obj } { unknown-field }
  { The~field~you~have~provided~is~not~known~to~exist~for~this~object:~`#1'.`#2' }

\cs_new:Nn \obj_new:nn
  {
    \prop_new:c { g__obj_#1_spec_prop }
    \prop_new:c { g__obj_#1_proto_prop }
    \parse_dictionary:nn {#2}
      {
        \clist_if_in:NVF
          \g__obj_obj__types_clist
          \l_parse_dictionary_type_tl
          {
            \msg_warning:nnx { obj } { unknown-type }
              { \tl_use:N \l_parse_dictionary_type_tl }
          }
        \prop_put:cVV { g__obj_#1_spec_prop }
          \l_parse_dictionary_key_tl
          \l_parse_dictionary_type_tl
        \prop_put:cVV { g__obj_#1_proto_prop }
          \l_parse_dictionary_key_tl
          \l_parse_dictionary_value_tl
        \__obj_new_getter:nV {#1} \l_parse_dictionary_key_tl
        \__obj_new_setter:nV {#1} \l_parse_dictionary_key_tl
      }
    \cs_set_eq:cN { #1_new:N } \prop_new:N
    \cs_set_eq:cN { #1_show:N } \prop_show:N
    \cs_new:cpn { #1_set:Nn } { \__obj_set:nNn {#1} }
    \cs_new:cn { #1_new:Nn }
      {
        \use:c { #1_new:N  } ##1
        \use:c { #1_set:Nn } ##1 {##2}
        \prop_map_inline:cn { g__obj_#1_proto_prop }
          { \prop_put_if_new:Nnn ##1 {####1} {####2} }
      }
  }

\cs_new:Nn \__obj_new_getter:nn
  { \cs_new:cn { #1_#2:N } { \prop_item:Nn ##1 {#2} } }
\cs_new:Nn \__obj_new_setter:nn
  { \cs_new:cn { #1_#2:Nn } { \prop_put:Nnn ##1 {#2} {##2} } }
\cs_generate_variant:Nn \__obj_new_getter:nn { nV }
\cs_generate_variant:Nn \__obj_new_setter:nn { nV }

\cs_new:Nn \__obj_set:nNn
  {
    \parse_prop:nn {#3}
      {
        \prop_if_in:cVF { g__obj_#1_spec_prop } \l_parse_prop_key_tl
          {
            \msg_error:nnnx { obj } { unknown-field } {#1}
              { \tl_use:N \l_parse_prop_key_tl }
          }
        \prop_put:NVV #2 \l_parse_prop_key_tl \l_parse_prop_value_tl
      }
  }

\cs_new:Nn \obj_show:n
  {
    \prop_show:c { g__obj_#1_spec_prop }
    \prop_show:c { g__obj_#1_proto_prop }
  }
